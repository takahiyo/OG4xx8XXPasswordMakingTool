<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <script>
      function notifyReady(targetWindow, targetOrigin) {
        const destination = targetWindow || window.parent;
        if (!destination) {
          return;
        }
        const origin = typeof targetOrigin === 'string' && targetOrigin ? targetOrigin : '*';
        try {
          destination.postMessage({ type: 'bridge-ready' }, origin);
        } catch (err) {
          // ignore
        }
      }

      function sendResult(targetWindow, targetOrigin, requestId, payload) {
        const message = Object.assign({ type: 'bridge-result', requestId }, payload);
        targetWindow.postMessage(message, targetOrigin);
      }

      window.addEventListener('message', function(event) {
        if (!event || !event.data) {
          return;
        }

        const data = event.data;
        if (data === 'bridge-init' || data.type === 'bridge-init') {
          notifyReady(event.source, event.origin);
          return;
        }

        if (data.type !== 'generate') {
          return;
        }
        const requestId = event.data.requestId;
        const mac = event.data.mac;
        if (typeof requestId !== 'string' || !requestId) {
          return;
        }
        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.error) {
              sendResult(event.source, event.origin, requestId, { error: result.error });
              return;
            }
            if (result && result.password) {
              sendResult(event.source, event.origin, requestId, { password: result.password });
              return;
            }
            sendResult(event.source, event.origin, requestId, { error: '応答が不正です。' });
          })
          .withFailureHandler(function(err) {
            const message = err && err.message ? String(err.message) : '内部エラーが発生しました。';
            sendResult(event.source, event.origin, requestId, { error: message });
          })
          .generatePasswordForBridge(mac);
      });

      window.addEventListener('load', function() {
        notifyReady();
      });
    </script>
  </head>
  <body></body>
</html>
